#include "../include/mainwindow.hpp"
#include "../include/predictdialog.hpp"
#include "../include/trainoptionswindow.hpp"
#include "../include/testoptionswindow.hpp"
#include "../include/configdialog.hpp"
#include <functional>
#include <QStyle>
#include <QDesktopWidget>
#include <QScreen>
#include <thread>
#include <QtCore/QModelIndex>
#include <QtCore/QThread>
#include <QtCore/QTextStream>
#include <iostream>
#include <QtWidgets/QtWidgets>
#include "ui_mainwindow.h"
#include "../include/workers/trainmodelworker.hpp"
#include "../include/workers/testmodelworker.hpp"
#include "../include/workers/predictworker.hpp"
#include "../include/trans.hpp"


MainWindow::MainWindow(QWidget *parent) :
    QMainWindow(parent),
    ui(new Ui::MainWindow)
{
    ui->setupUi(this);
    ui->progressBar->hide();

    //Prediction
    qRegisterMetaType<PredictionStarted>("PredictionStarted");
    qRegisterMetaType<PredictionCompleted>("PredictionCompleted");
    connect(this, &MainWindow::predictionStarted, this, &MainWindow::handle_PredictionStarted);
    connect(this, &MainWindow::predictionCompleted, this, &MainWindow::handle_PredictionCompleted);

    //Training
    qRegisterMetaType<TrainingStarted>("TrainingStarted");
    qRegisterMetaType<TrainingStarted>("TrainingCompleted");
    connect(this, &MainWindow::trainingStarted, this, &MainWindow::handle_TrainingStarted);
    connect(this, &MainWindow::trainingCompleted, this, &MainWindow::handle_TrainingCompleted);

    //Test
    qRegisterMetaType<TestStarted>("TestStarted");
    qRegisterMetaType<TestCompleted>("TestCompleted");
    connect(this, &MainWindow::testStarted, this, &MainWindow::handle_TestStarted);
    connect(this, &MainWindow::testCompleted, this, &MainWindow::handle_TestCompleted);

    //Stages
    qRegisterMetaType<StageChanged>("StageChanged");
    connect(this, &MainWindow::stateChanged, this, &MainWindow::handle_StageChanged);

    //Errors
    qRegisterMetaType<ErrorOccurred>("ErrorOccurred");
    connect(this, &MainWindow::errorOccured, this, &MainWindow::handle_ErrorOccured);
}

MainWindow::MainWindow(const std::shared_ptr<DetectorSupervisor>& supervisor, QWidget *parent) :
    MainWindow(parent)
{
    _supervisor = supervisor;
}

MainWindow::~MainWindow()
{
    delete ui;
}


void MainWindow::centerAndResize()
{
    QSize currentSize = geometry().size();
    QSize newSize( currentSize.width(), currentSize.height() );

    setGeometry(
        QStyle::alignedRect(
            Qt::LeftToRight,
            Qt::AlignCenter,
            newSize,
            QApplication::screens()[0]->geometry()
        )
    );

    setFixedSize(newSize);
}

void MainWindow::on_trainPushButton_clicked()
{
    TrainOptionsWindow dialog;
    auto res = dialog.exec();

    if (res == QDialog::Accepted) {
        QMessageBox box(QMessageBox::Question, tr("Potwierdzenie"), tr("Rozpocząć trening modelu?"), QMessageBox::Yes | QMessageBox::No, this);
        box.setButtonText(QMessageBox::Yes, tr("Tak"));
        box.setButtonText(QMessageBox::No, tr("Nie"));

        if (box.exec() == QMessageBox::Yes) {
            clearLog();

            auto dir =  dialog.getDirectoryPath().toStdString();
            auto label = dialog.getLabelsPath().toStdString();

            TrainModelWorker* worker = new TrainModelWorker(_supervisor, dir, label); // memory leak!!!!!
            worker->start();
        }
    }
}

void MainWindow::on_predictPushButton_clicked()
{
    PredictDialog dialog;
    auto res = dialog.exec();

    if (res == QDialog::Accepted) {
        QMessageBox box(QMessageBox::Question, tr("Potwierdzenie"), tr("Rozpocząć predykcję?"), QMessageBox::Yes | QMessageBox::No, this);
        box.setButtonText(QMessageBox::Yes, tr("Tak"));
        box.setButtonText(QMessageBox::No, tr("Nie"));

        if (box.exec() == QMessageBox::Yes) {
            clearLog();

            auto path = dialog.getFilepath().toStdString();
            PredictWorker* worker = new PredictWorker(_supervisor, path); // memory leak!!!!!
            worker->start();
        }
    }
}

void MainWindow::on_testPushButton_clicked()
{

    TestOptionsWindow dialog;
    auto res = dialog.exec();

    if (res == QDialog::Accepted) {
        QMessageBox box(QMessageBox::Question, tr("Potwierdzenie"), tr("Rozpocząć test modelu?"), QMessageBox::Yes | QMessageBox::No, this);
        box.setButtonText(QMessageBox::Yes, tr("Tak"));
        box.setButtonText(QMessageBox::No, tr("Nie"));

        if (box.exec() == QMessageBox::Yes) {
            clearLog(); // clear list

            auto dir =  dialog.getDirectoryPath().toStdString();
            auto label = dialog.getLabelsPath().toStdString();

            TestModelWorker* worker = new TestModelWorker(_supervisor, dir, label); // memory leak!!!
            worker->start();
        }
    }
}

void MainWindow::on_configPushButton_clicked()
{
    auto configs = _supervisor->getAllConfigurations();

    ConfigDialog dialog(configs);

    auto res = dialog.exec();

    if (res == ConfigDialog::ConfigSelected) {
        _supervisor->loadConfiguration(dialog.getSelectedConfigId());
    }
}

void MainWindow::on_exitPushButton_clicked()
{
    close();
}

void MainWindow::handle_PredictionStarted(PredictionStarted ev)
{
    ui->listWidget->addItem("Predykcja rozpoczęta.");
}

void MainWindow::handle_PredictionCompleted(PredictionCompleted ev)
{
    QMessageBox box;
    box.setStandardButtons(QMessageBox::Ok);
    box.setWindowTitle("Predykcja zakończona");

    // TODO: change string building to more effective method!!!!
    QString str;
    str += "Badany plik: "; str += QString::fromStdString(ev.filename); str += "\n";
    str += "Identyfikator etykiety: "; str += QString::number(ev.outcomeLabelId); str += "\n";
    str += "Nazwa etykiety(rodzina oprogramowania): "; str += QString::fromStdString(ev.virusFamilyLabel); str += "\n";
    str += "Ilość deskryptorów: "; str += QString::number(ev.totalExtractedFeatures); str += "\n";

    box.setText(str);

    box.exec();
}

void MainWindow::handle_TrainingStarted(TrainingStarted ev)
{
    ui->progressBar->show();
    ui->listWidget->addItem("Trening rozpoczęty.");
}

void MainWindow::handle_TrainingCompleted(TrainingCompleted)
{
    ui->progressBar->hide();
    ui->listWidget->addItem("Trening zakończony pomyślnie.");

    QMessageBox box(QMessageBox::Question, tr("Zapis konfiguracji"), tr("Czy zapisać wytrenowany model?"), QMessageBox::Yes | QMessageBox::No, this);
    box.setButtonText(QMessageBox::Yes, tr("Tak"));
    box.setButtonText(QMessageBox::No, tr("Nie"));

    if (box.exec() == QMessageBox::Yes) {
        _supervisor->saveCurrentConfiguration();
    }
}

void MainWindow::handle_TestStarted(TestStarted ev)
{
    ui->listWidget->addItem("Test rozpoczęty.");
}

void MainWindow::handle_TestCompleted(TestCompleted ev)
{
    ui->listWidget->addItem("Test zakończony.");

    QMessageBox box;
    box.setWindowTitle("Wyniki testu");
    box.setStandardButtons(QMessageBox::Ok);

    // TODO: change string building to more effective method!!!!
    QString str;
    str += "Ilość plików: ";                str += QString::number(ev.totalFiles);          str += "\n";
    str += "Przewidzianych prawidłowo: ";   str += QString::number(ev.goodPredicted);       str += "\n";
    str += "Przewidzianych błędnie: ";      str += QString::number(ev.badPredicted);        str += "\n";
    str += "Odrzuconych: ";                 str += QString::number(ev.rejectedFiles.size());str += "\n";
    str += "Skuteczność:";                  str += QString::number(ev.accurracy) += "%";    str += "\n" ;

    box.setText(str);
    box.exec();
}

void MainWindow::handle_StageChanged(StageChanged ev)
{
    QString str;
    QTextStream out(&str);

    out << "Etap: "
        << ev.stageNumber
        << " - ";

    if (ev.currentState == STAGE_STATE::STARTED) {
        out << QString("rozpoczęty.");
        ui->progressBar->setValue(ev.stageNumber);
    } else {
        out << QString("zakończony.");
    }

    ui->listWidget->addItem(str);
}

void MainWindow::handle_ErrorOccured(ErrorOccurred ev)
{
    auto msg = QString("Błąd. ");
    auto msgText = Trans::get(ev.code);

    msg += msgText;

    ui->listWidget->addItem(msg);
}

void MainWindow::on_actionClose_triggered()
{
    close();
}

void MainWindow::on_actionFAQ_triggered()
{

    QMessageBox box;
    box.setWindowTitle("FAQ");
    box.setText("Pomoc");

    box.exec();
}

void MainWindow::clearLog()
{
    ui->listWidget->clear();
}