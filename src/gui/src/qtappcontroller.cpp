//
// Created by pp on 20.01.19.
//

#include <QtWidgets/QApplication>
#include "../include/qtappcontroller.hpp"
#include "../include/mainwindow.hpp"
#include <functional>
//#include "../engine/includes/KMeansWrapper.hpp"
//#include "../engine/includes/OpenCvSurfExtractor.hpp"
//#include "../engine/includes/StandardScaler.hpp"
//#include "../engine/includes/SVCDomainClassifier.hpp"

//int main(int argc, char** argv)
//{
//    auto bus = std::make_unique<MessageBus>();
//    auto detector = std::make_unique<DetectionEngine>(bus);
////    detector->setClusterClassifier(std::make_shared<KMeansWrapper>(100));
////    detector->setFeaturesExtractor(std::make_shared<OpenCvSurfExtractor>());
////    detector->setDomainClassifier(std::make_shared<SVCDomainClassifier>());
////    detector->setDataScaler(std::make_shared<StandardScaler>());
//
//    auto appController = QtAppController(detector, bus);
//
//    return appController.run(argc, argv);
//}
//

int QtAppController::run(int argc, char **argv)
{
    QApplication a(argc, argv);
    MainWindow w(this);
    w.centerAndResize();


    w.show();

    _bus->onTrainingStarted.connect([&w](TrainingStarted ev)->void { emit w.trainingStarted(ev); });
    _bus->onTrainingCompleted.connect([&w](TrainingCompleted ev)->void { emit w.trainingCompleted(ev); });

    _bus->onStageChanged.connect([&w](StageChanged ev)->void { emit w.stateChanged(ev); });


    return a.exec();
}

void QtAppController::train() {
    const std::string trainLabelsSource = "../../dataset/ml2/train/trainLabels-90.csv";
    const std::string trainDataRootSource = "../../dataset/ml2/train";

    const std::string testLabelsSource = "../../dataset/ml2/test/testLabels-45.csv";
    const std::string testDataRootSource = "../../dataset/ml2/test";

    auto trainDataset = std::make_unique<Dataset>(trainLabelsSource, trainDataRootSource);
    _detectionEngine->train(trainDataset);
//
}
