//
// Created by pp on 10.01.19.
//

#include <fstream>
#include "../includes/Dataset.hpp"
#include "../../errors.hpp"
#include "../../exception.hpp"

Dataset::Dataset(const std::string& metadata_path, const std::string& data_root)
{
    std::fstream file(metadata_path);

    if (!file.is_open()) {
        throw app_exception(errors::codes::dataset_path_invalid, "Path to datset metadata file is invalid.");
    }

    _metadataPath = metadata_path;
    _dataRootPath = data_root;
}

std::vector<Sample> Dataset::getSamples()
{
    //refactor
    if (!isInitialized()) {
        std::fstream file(_metadataPath);

        if (file.bad()) {
            throw app_exception(errors::codes::dataset_file_invalid, "Metadata file for dataset is invalid.");
        }

        while (file) {
            std::string filename;
            std::string label;
            int labelId;
            char separator;

            file
            >> filename
            >> separator
            >> labelId;

            if (filename.empty()) {
                continue;
            }

            _samples.emplace_back(filename, _dataRootPath, labelId);
        }
    }

    if (_samples.empty()) {
        throw app_exception(errors::codes::dataset_file_invalid);
    }

    return _samples;
}

bool Dataset::isInitialized() { return !_samples.empty(); }
