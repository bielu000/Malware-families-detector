//
// Created by pp on 15.01.19.
//

#include "../includes/KMeansWrapper.hpp"

cv::Mat KMeansWrapper::cluster(const cv::Mat& features)
{
    cv::kmeans(
            features,
            _clustersCount,
            _featuresClustersLabels,
            cv::TermCriteria(cv::TermCriteria::MAX_ITER + cv::TermCriteria::EPS, 300, 0.0001),
            10,
            cv::KMEANS_PP_CENTERS,
            _centers
    );

    return _featuresClustersLabels;
}

void KMeansWrapper::train(const cv::Mat &features, cv::Mat &clusters)
{
    matcher->add(_centers);
    matcher->train();
    matcher->save("matcher-dump");
}

cv::Mat KMeansWrapper::predict(const cv::Mat& features)
{
    cv::Mat out;

    std::vector<cv::DMatch> matches;

    matcher->match(features, matches);

    for (auto const& x : matches)
    {
        out.push_back(x.trainIdx);
    }

    return out;
}