//
// Created by pp on 26.01.19.
//

#include <fstream>
#include <algorithm>
#include "../includes/FileConfigProvider.hpp"
#include "../../exception.hpp"


void FileConfigProvider::addConfiguration(const Config &cfg)
{
    _configs.push_back(cfg);
}

void FileConfigProvider::save()
{
    std::fstream file(_filename, std::ios::out);

    if (file.bad()) {
        throw ApplicationException(errors::codes::cannot_save_config, "Cannot save config.");
    }

    std::unique_ptr<JsonSerializer<Config>> serializer = std::make_unique<ConfigSerializer>();
    auto result = serializer->serialize(_configs);

    file << result;
}

const std::vector<Config> FileConfigProvider::getAllConfigurations()
{
    if (_isInitialized) {
        return _configs;
    }

    init();


    return _configs;
}

const Config FileConfigProvider::getConfiguration(const std::string& id)
{
    if (!_isInitialized) {
        init();
    }

    auto it = std::find_if(_configs.begin(), _configs.end(), [&](const Config cfg)-> bool { return cfg.id == id; });

    if (it == _configs.end()) {
        throw ApplicationException(errors::codes::cannot_save_config);
    }

    return *it;
}

void FileConfigProvider::init()
{
    std::fstream file(_filename, std::ios::in);

    if (file.bad()) {
        throw ApplicationException(errors::codes::cannot_find_config);
    }

    std::stringstream stream;
    std::string content;

    while (file >> content) {
        stream << content;
    }

    std::unique_ptr<JsonDeserializer<Config>> deserializer = std::make_unique<ConfigDeserializer>(stream);

    _configs = deserializer->deserialize();
    _isInitialized = true;
}